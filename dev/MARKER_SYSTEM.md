# Marker-Based Documentation Auto-Generation

This directory contains scripts to auto-generate documentation from Rust source docstrings.

## Overview

The Rust source code is the **single source of truth** for all parameter documentation. Documentation is automatically generated by extracting `///` doc comments from struct fields.

## The Marker System

### For template.toml

Add markers around sections you want to auto-generate:

```toml
# ==== ExtractIUPAC ====
# Extract a IUPAC string.
# [[step]]
#    action = "ExtractIUPAC"
# AUTO-GENERATED-START: IUPAC
#    ... fields will be auto-generated here ...
# AUTO-GENERATED-END
```

The struct name (`IUPAC`) must match the Rust struct name, not the transformation name.

### For Markdown Documentation

Add markers in markdown files:

```markdown
## Parameters

<!-- AUTO-GENERATED-START: IUPAC -->
... parameter list will be auto-generated here ...
<!-- AUTO-GENERATED-END -->
```

## Usage

### Update Everything

```bash
dev/_update_docs.sh
```

This runs `update_docs_from_rust.py --all` and updates both template.toml and markdown files.

### Update Only template.toml

```bash
python3 dev/update_docs_from_rust.py --template
```

### Update Only Markdown

```bash
python3 dev/update_docs_from_rust.py --markdown
```

## Adding Markers to New Sections

### In template.toml

1. Find the transformation section
2. Add markers around the field definitions:
   ```toml
   # AUTO-GENERATED-START: StructName
   # AUTO-GENERATED-END
   ```
3. Run `dev/_update_docs.sh`

### In Markdown Files

1. Find the parameters section
2. Add HTML comment markers:
   ```markdown
   <!-- AUTO-GENERATED-START: StructName -->
   <!-- AUTO-GENERATED-END -->
   ```
3. Run `dev/_update_docs.sh`

## Finding the Struct Name

The struct name is **not** the same as the transformation action name. To find it:

1. Look in `mbf-fastq-processor/src/transformations.rs`
2. Find your transformation in the enum:
   ```rust
   pub enum Transformation {
       ExtractIUPAC(extract::IUPAC),  // Action: ExtractIUPAC, Struct: IUPAC
       ExtractRegion(extract::Region), // Action: ExtractRegion, Struct: Region
   }
   ```
3. Use the struct name (after the `::`) in your markers

## How It Works

1. **Extract**: The script scans all Rust files in `src/transformations/` and `src/config/`
2. **Parse**: It extracts `///` doc comments from struct fields
3. **Generate**: Content between markers is replaced with formatted documentation
4. **Preserve**: Everything outside markers remains unchanged

## Generated Output Formats

### template.toml

```toml
# AUTO-GENERATED-START: IUPAC
#    search = "AGTC" # What we are searching. Can be a single IUPAC string...
#    segment = "read1" # Any of your input segments (default: read1) (optional)
# AUTO-GENERATED-END
```

### Markdown

```markdown
<!-- AUTO-GENERATED-START: IUPAC -->
- **`search`**: What we are searching. Can be a single IUPAC string...
- **`segment`** *(optional)*: Any of your input segments (default: read1)
<!-- AUTO-GENERATED-END -->
```

## Best Practices

1. **Write Good Docstrings**: Since Rust is the source of truth, invest time in clear, comprehensive `///` comments
2. **One Sentence Per Concept**: Keep docstrings concise but complete
3. **Defaults in Docs**: Mention default values in the docstring (e.g., "default: read1")
4. **Run After Changes**: Always run `dev/_update_docs.sh` after modifying struct docstrings
5. **Review Output**: Check the generated documentation makes sense

## Troubleshooting

**Markers not being replaced?**
- Check the struct name matches exactly (case-sensitive)
- Verify markers use the correct format
- Run with `--template` or `--markdown` flag explicitly

**Missing fields?**
- Ensure fields have `///` doc comments
- Check fields aren't marked `#[serde(skip)]`
- Private fields are OK - they're included if documented

**Wrong example values?**
- Edit `get_example_value()` in `update_docs_from_rust.py`
- Add name-based or type-based heuristics

## Scripts

- **`update_docs_from_rust.py`**: Main script with marker-based generation
- **`update_template_from_rust_docs.py`**: Older inline comment updater (still works)
- **`_update_docs.sh`**: Convenience wrapper
- **`_update_template.sh`**: Legacy wrapper for inline comments
